from typing import List

from prowler.lib.check.models import Check, CheckReportMicrosoft365
from prowler.providers.microsoft365.services.defender.defender_client import (
    defender_client,
)


class defender_policy_notifications_internal_users_malware_enabled(Check):
    """
    Check if notifications for internal users sending malware are enabled in the Defender anti-malware policy.

    Attributes:
        metadata: Metadata associated with the check (inherited from Check).
    """

    def execute(self) -> List[CheckReportMicrosoft365]:
        """
        Execute the check to verify if notifications for internal users sending malware are enabled.

        This method checks the Defender anti-malware policy to determine if notifications for internal users
        sending malware are enabled.

        Returns:
            List[CheckReportMicrosoft365]: A list of reports containing the result of the check.
        """
        findings = []
        malware_policy = defender_client.malware_policy
        report = CheckReportMicrosoft365(
            metadata=self.metadata(),
            resource=malware_policy if malware_policy else {},
            resource_name="Defender Malware Policy",
            resource_id="defenderMalwarePolicy",
        )

        # Check if internal sender admin notifications are enabled
        if malware_policy and malware_policy.enable_internal_sender_admin_notifications:
            # Check if there is at least one email address for internal sender admin notifications
            if malware_policy.internal_sender_admin_address:
                report.status = "PASS"
                report.status_extended = (
                    "Notifications for internal users sending malware are enabled."
                )
            else:
                report.status = "FAIL"
                report.status_extended = "Notifications for internal users sending malware are enabled, but no email addresses are configured."
        else:
            report.status = "FAIL"
            report.status_extended = (
                "Notifications for internal users sending malware are not enabled."
            )

        findings.append(report)

        return findings
